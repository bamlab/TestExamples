ff5588ed146b5a6956e9690048e5f9dc
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var css = require('css');

var _require = require('./utils'),
    getCSS = _require.getCSS,
    getHashes = _require.getHashes;

var KEY = '__jest-styled-components__';

var getNodes = function getNodes(node) {
  var nodes = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : [];

  if (typeof node === 'object') {
    nodes.push(node);
  }

  if (node.children) {
    Array.from(node.children).forEach(function (child) {
      return getNodes(child, nodes);
    });
  }

  return nodes;
};

var markNodes = function markNodes(nodes) {
  return nodes.forEach(function (node) {
    return node[KEY] = true;
  });
};

var getClassNamesFromDOM = function getClassNamesFromDOM(node) {
  return Array.from(node.classList);
};

var getClassNamesFromProps = function getClassNamesFromProps(node) {
  var classNameProp = node.props && (node.props.class || node.props.className);

  if (classNameProp) {
    return classNameProp.trim().split(/\s+/);
  }

  return [];
};

var getClassNames = function getClassNames(nodes) {
  return nodes.reduce(function (classNames, node) {
    var newClassNames = null;

    if (global.Element && node instanceof global.Element) {
      newClassNames = getClassNamesFromDOM(node);
    } else {
      newClassNames = getClassNamesFromProps(node);
    }

    newClassNames.forEach(function (className) {
      return classNames.add(className);
    });
    return classNames;
  }, new Set());
};

var filterClassNames = function filterClassNames(classNames, hashes) {
  return classNames.filter(function (className) {
    return hashes.includes(className);
  });
};

var includesClassNames = function includesClassNames(classNames, selectors) {
  return classNames.some(function (className) {
    return selectors.some(function (selector) {
      return selector.includes(className);
    });
  });
};

var filterRules = function filterRules(classNames) {
  return function (rule) {
    return rule.type === 'rule' && includesClassNames(classNames, rule.selectors) && rule.declarations.length;
  };
};

var getAtRules = function getAtRules(ast, filter) {
  return ast.stylesheet.rules.filter(function (rule) {
    return rule.type === 'media' || rule.type === 'supports';
  }).reduce(function (acc, atRule) {
    atRule.rules = atRule.rules.filter(filter);

    if (atRule.rules.length) {
      return acc.concat(atRule);
    }

    return acc;
  }, []);
};

var getStyle = function getStyle(classNames) {
  var ast = getCSS();
  var filter = filterRules(classNames);
  var rules = ast.stylesheet.rules.filter(filter);
  var atRules = getAtRules(ast, filter);
  ast.stylesheet.rules = rules.concat(atRules);
  return css.stringify(ast);
};

var getClassNamesFromSelectorsByHashes = function getClassNamesFromSelectorsByHashes(classNames, hashes) {
  var ast = getCSS();
  var filter = filterRules(classNames);
  var rules = ast.stylesheet.rules.filter(filter);
  var selectors = rules.map(function (rule) {
    return rule.selectors;
  });
  var classNamesIncludingFromSelectors = new Set(classNames);

  var addHashFromSelectorListToClassNames = function addHashFromSelectorListToClassNames(hash) {
    return selectors.forEach(function (selectorList) {
      return selectorList[0].includes(hash) && classNamesIncludingFromSelectors.add(hash);
    });
  };

  hashes.forEach(addHashFromSelectorListToClassNames);
  return (0, _toConsumableArray2.default)(classNamesIncludingFromSelectors);
};

var replaceClassNames = function replaceClassNames(result, classNames, style) {
  return classNames.filter(function (className) {
    return style.includes(className);
  }).reduce(function (acc, className, index) {
    return acc.replace(new RegExp(className, 'g'), "c" + index++);
  }, result);
};

var replaceHashes = function replaceHashes(result, hashes) {
  return hashes.reduce(function (acc, className) {
    return acc.replace(new RegExp("((class|className)=\"[^\"]*?)" + className + "\\s?([^\"]*\")", 'g'), '$1$3');
  }, result);
};

var styleSheetSerializer = {
  test: function test(val) {
    return val && !val[KEY] && (val.$$typeof === (typeof Symbol === "function" ? Symbol.for : "@@for")('react.test.json') || global.Element && val instanceof global.Element);
  },
  print: function print(val, _print) {
    var nodes = getNodes(val);
    markNodes(nodes);
    var hashes = getHashes();
    var classNames = (0, _toConsumableArray2.default)(getClassNames(nodes));
    classNames = filterClassNames(classNames, hashes);
    var style = getStyle(classNames);
    var classNamesToReplace = getClassNamesFromSelectorsByHashes(classNames, hashes);

    var code = _print(val);

    var result = "" + style + (style ? '\n\n' : '') + code;
    result = replaceClassNames(result, classNamesToReplace, style);
    result = replaceHashes(result, hashes);
    return result;
  }
};
module.exports = styleSheetSerializer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN0eWxlU2hlZXRTZXJpYWxpemVyLmpzIl0sIm5hbWVzIjpbImNzcyIsInJlcXVpcmUiLCJnZXRDU1MiLCJnZXRIYXNoZXMiLCJLRVkiLCJnZXROb2RlcyIsIm5vZGUiLCJub2RlcyIsInB1c2giLCJjaGlsZHJlbiIsIkFycmF5IiwiZnJvbSIsImZvckVhY2giLCJjaGlsZCIsIm1hcmtOb2RlcyIsImdldENsYXNzTmFtZXNGcm9tRE9NIiwiY2xhc3NMaXN0IiwiZ2V0Q2xhc3NOYW1lc0Zyb21Qcm9wcyIsImNsYXNzTmFtZVByb3AiLCJwcm9wcyIsImNsYXNzIiwiY2xhc3NOYW1lIiwidHJpbSIsInNwbGl0IiwiZ2V0Q2xhc3NOYW1lcyIsInJlZHVjZSIsImNsYXNzTmFtZXMiLCJuZXdDbGFzc05hbWVzIiwiZ2xvYmFsIiwiRWxlbWVudCIsImFkZCIsIlNldCIsImZpbHRlckNsYXNzTmFtZXMiLCJoYXNoZXMiLCJmaWx0ZXIiLCJpbmNsdWRlcyIsImluY2x1ZGVzQ2xhc3NOYW1lcyIsInNlbGVjdG9ycyIsInNvbWUiLCJzZWxlY3RvciIsImZpbHRlclJ1bGVzIiwicnVsZSIsInR5cGUiLCJkZWNsYXJhdGlvbnMiLCJsZW5ndGgiLCJnZXRBdFJ1bGVzIiwiYXN0Iiwic3R5bGVzaGVldCIsInJ1bGVzIiwiYWNjIiwiYXRSdWxlIiwiY29uY2F0IiwiZ2V0U3R5bGUiLCJhdFJ1bGVzIiwic3RyaW5naWZ5IiwiZ2V0Q2xhc3NOYW1lc0Zyb21TZWxlY3RvcnNCeUhhc2hlcyIsIm1hcCIsImNsYXNzTmFtZXNJbmNsdWRpbmdGcm9tU2VsZWN0b3JzIiwiYWRkSGFzaEZyb21TZWxlY3Rvckxpc3RUb0NsYXNzTmFtZXMiLCJoYXNoIiwic2VsZWN0b3JMaXN0IiwicmVwbGFjZUNsYXNzTmFtZXMiLCJyZXN1bHQiLCJzdHlsZSIsImluZGV4IiwicmVwbGFjZSIsIlJlZ0V4cCIsInJlcGxhY2VIYXNoZXMiLCJzdHlsZVNoZWV0U2VyaWFsaXplciIsInRlc3QiLCJ2YWwiLCIkJHR5cGVvZiIsIlN5bWJvbCIsImZvciIsInByaW50IiwiY2xhc3NOYW1lc1RvUmVwbGFjZSIsImNvZGUiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiOzs7O0FBQUEsSUFBTUEsR0FBRyxHQUFHQyxPQUFPLENBQUMsS0FBRCxDQUFuQjs7ZUFDOEJBLE9BQU8sQ0FBQyxTQUFELEM7SUFBN0JDLE0sWUFBQUEsTTtJQUFRQyxTLFlBQUFBLFM7O0FBRWhCLElBQU1DLEdBQUcsR0FBRyw0QkFBWjs7QUFFQSxJQUFNQyxRQUFRLEdBQUcsU0FBWEEsUUFBVyxDQUFDQyxJQUFELEVBQXNCO0FBQUEsTUFBZkMsS0FBZSx1RUFBUCxFQUFPOztBQUNyQyxNQUFJLE9BQU9ELElBQVAsS0FBZ0IsUUFBcEIsRUFBOEI7QUFDNUJDLElBQUFBLEtBQUssQ0FBQ0MsSUFBTixDQUFXRixJQUFYO0FBQ0Q7O0FBRUQsTUFBSUEsSUFBSSxDQUFDRyxRQUFULEVBQW1CO0FBQ2pCQyxJQUFBQSxLQUFLLENBQUNDLElBQU4sQ0FBV0wsSUFBSSxDQUFDRyxRQUFoQixFQUEwQkcsT0FBMUIsQ0FBa0MsVUFBQUMsS0FBSztBQUFBLGFBQUlSLFFBQVEsQ0FBQ1EsS0FBRCxFQUFRTixLQUFSLENBQVo7QUFBQSxLQUF2QztBQUNEOztBQUVELFNBQU9BLEtBQVA7QUFDRCxDQVZEOztBQVlBLElBQU1PLFNBQVMsR0FBRyxTQUFaQSxTQUFZLENBQUFQLEtBQUs7QUFBQSxTQUFJQSxLQUFLLENBQUNLLE9BQU4sQ0FBYyxVQUFBTixJQUFJO0FBQUEsV0FBS0EsSUFBSSxDQUFDRixHQUFELENBQUosR0FBWSxJQUFqQjtBQUFBLEdBQWxCLENBQUo7QUFBQSxDQUF2Qjs7QUFFQSxJQUFNVyxvQkFBb0IsR0FBRyxTQUF2QkEsb0JBQXVCLENBQUFULElBQUk7QUFBQSxTQUFJSSxLQUFLLENBQUNDLElBQU4sQ0FBV0wsSUFBSSxDQUFDVSxTQUFoQixDQUFKO0FBQUEsQ0FBakM7O0FBQ0EsSUFBTUMsc0JBQXNCLEdBQUcsU0FBekJBLHNCQUF5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QkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBjc3MgPSByZXF1aXJlKCdjc3MnKVxuY29uc3QgeyBnZXRDU1MsIGdldEhhc2hlcyB9ID0gcmVxdWlyZSgnLi91dGlscycpXG5cbmNvbnN0IEtFWSA9ICdfX2plc3Qtc3R5bGVkLWNvbXBvbmVudHNfXydcblxuY29uc3QgZ2V0Tm9kZXMgPSAobm9kZSwgbm9kZXMgPSBbXSkgPT4ge1xuICBpZiAodHlwZW9mIG5vZGUgPT09ICdvYmplY3QnKSB7XG4gICAgbm9kZXMucHVzaChub2RlKVxuICB9XG5cbiAgaWYgKG5vZGUuY2hpbGRyZW4pIHtcbiAgICBBcnJheS5mcm9tKG5vZGUuY2hpbGRyZW4pLmZvckVhY2goY2hpbGQgPT4gZ2V0Tm9kZXMoY2hpbGQsIG5vZGVzKSlcbiAgfVxuXG4gIHJldHVybiBub2Rlc1xufVxuXG5jb25zdCBtYXJrTm9kZXMgPSBub2RlcyA9PiBub2Rlcy5mb3JFYWNoKG5vZGUgPT4gKG5vZGVbS0VZXSA9IHRydWUpKVxuXG5jb25zdCBnZXRDbGFzc05hbWVzRnJvbURPTSA9IG5vZGUgPT4gQXJyYXkuZnJvbShub2RlLmNsYXNzTGlzdClcbmNvbnN0IGdldENsYXNzTmFtZXNGcm9tUHJvcHMgPSBub2RlID0+IHtcbiAgY29uc3QgY2xhc3NOYW1lUHJvcCA9IG5vZGUucHJvcHMgJiYgKG5vZGUucHJvcHMuY2xhc3MgfHwgbm9kZS5wcm9wcy5jbGFzc05hbWUpXG5cbiAgaWYgKGNsYXNzTmFtZVByb3ApIHtcbiAgICByZXR1cm4gY2xhc3NOYW1lUHJvcC50cmltKCkuc3BsaXQoL1xccysvKVxuICB9XG5cbiAgcmV0dXJuIFtdXG59XG5cbmNvbnN0IGdldENsYXNzTmFtZXMgPSBub2RlcyA9PlxuICBub2Rlcy5yZWR1Y2UoKGNsYXNzTmFtZXMsIG5vZGUpID0+IHtcbiAgICBsZXQgbmV3Q2xhc3NOYW1lcyA9IG51bGxcblxuICAgIGlmIChnbG9iYWwuRWxlbWVudCAmJiBub2RlIGluc3RhbmNlb2YgZ2xvYmFsLkVsZW1lbnQpIHtcbiAgICAgIG5ld0NsYXNzTmFtZXMgPSBnZXRDbGFzc05hbWVzRnJvbURPTShub2RlKVxuICAgIH0gZWxzZSB7XG4gICAgICBuZXdDbGFzc05hbWVzID0gZ2V0Q2xhc3NOYW1lc0Zyb21Qcm9wcyhub2RlKVxuICAgIH1cblxuICAgIG5ld0NsYXNzTmFtZXMuZm9yRWFjaChjbGFzc05hbWUgPT4gY2xhc3NOYW1lcy5hZGQoY2xhc3NOYW1lKSlcblxuICAgIHJldHVybiBjbGFzc05hbWVzXG4gIH0sIG5ldyBTZXQoKSlcblxuY29uc3QgZmlsdGVyQ2xhc3NOYW1lcyA9IChjbGFzc05hbWVzLCBoYXNoZXMpID0+XG4gIGNsYXNzTmFtZXMuZmlsdGVyKGNsYXNzTmFtZSA9PiBoYXNoZXMuaW5jbHVkZXMoY2xhc3NOYW1lKSlcblxuY29uc3QgaW5jbHVkZXNDbGFzc05hbWVzID0gKGNsYXNzTmFtZXMsIHNlbGVjdG9ycykgPT5cbiAgY2xhc3NOYW1lcy5zb21lKGNsYXNzTmFtZSA9PlxuICAgIHNlbGVjdG9ycy5zb21lKHNlbGVjdG9yID0+IHNlbGVjdG9yLmluY2x1ZGVzKGNsYXNzTmFtZSkpXG4gIClcblxuY29uc3QgZmlsdGVyUnVsZXMgPSBjbGFzc05hbWVzID0+IHJ1bGUgPT5cbiAgcnVsZS50eXBlID09PSAncnVsZScgJiZcbiAgaW5jbHVkZXNDbGFzc05hbWVzKGNsYXNzTmFtZXMsIHJ1bGUuc2VsZWN0b3JzKSAmJlxuICBydWxlLmRlY2xhcmF0aW9ucy5sZW5ndGhcblxuY29uc3QgZ2V0QXRSdWxlcyA9IChhc3QsIGZpbHRlcikgPT5cbiAgYXN0LnN0eWxlc2hlZXQucnVsZXNcbiAgICAuZmlsdGVyKHJ1bGUgPT4gcnVsZS50eXBlID09PSAnbWVkaWEnIHx8IHJ1bGUudHlwZSA9PT0gJ3N1cHBvcnRzJylcbiAgICAucmVkdWNlKChhY2MsIGF0UnVsZSkgPT4ge1xuICAgICAgYXRSdWxlLnJ1bGVzID0gYXRSdWxlLnJ1bGVzLmZpbHRlcihmaWx0ZXIpXG5cbiAgICAgIGlmIChhdFJ1bGUucnVsZXMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiBhY2MuY29uY2F0KGF0UnVsZSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGFjY1xuICAgIH0sIFtdKVxuXG5jb25zdCBnZXRTdHlsZSA9IGNsYXNzTmFtZXMgPT4ge1xuICBjb25zdCBhc3QgPSBnZXRDU1MoKVxuICBjb25zdCBmaWx0ZXIgPSBmaWx0ZXJSdWxlcyhjbGFzc05hbWVzKVxuICBjb25zdCBydWxlcyA9IGFzdC5zdHlsZXNoZWV0LnJ1bGVzLmZpbHRlcihmaWx0ZXIpXG4gIGNvbnN0IGF0UnVsZXMgPSBnZXRBdFJ1bGVzKGFzdCwgZmlsdGVyKVxuXG4gIGFzdC5zdHlsZXNoZWV0LnJ1bGVzID0gcnVsZXMuY29uY2F0KGF0UnVsZXMpXG5cbiAgcmV0dXJuIGNzcy5zdHJpbmdpZnkoYXN0KVxufVxuXG5jb25zdCBnZXRDbGFzc05hbWVzRnJvbVNlbGVjdG9yc0J5SGFzaGVzID0gKGNsYXNzTmFtZXMsIGhhc2hlcykgPT4ge1xuICBjb25zdCBhc3QgPSBnZXRDU1MoKVxuICBjb25zdCBmaWx0ZXIgPSBmaWx0ZXJSdWxlcyhjbGFzc05hbWVzKVxuICBjb25zdCBydWxlcyA9IGFzdC5zdHlsZXNoZWV0LnJ1bGVzLmZpbHRlcihmaWx0ZXIpXG5cbiAgY29uc3Qgc2VsZWN0b3JzID0gcnVsZXMubWFwKHJ1bGUgPT4gcnVsZS5zZWxlY3RvcnMpXG4gIGNvbnN0IGNsYXNzTmFtZXNJbmNsdWRpbmdGcm9tU2VsZWN0b3JzID0gbmV3IFNldChjbGFzc05hbWVzKVxuICBjb25zdCBhZGRIYXNoRnJvbVNlbGVjdG9yTGlzdFRvQ2xhc3NOYW1lcyA9IGhhc2ggPT5cbiAgICBzZWxlY3RvcnMuZm9yRWFjaChcbiAgICAgIHNlbGVjdG9yTGlzdCA9PlxuICAgICAgICBzZWxlY3Rvckxpc3RbMF0uaW5jbHVkZXMoaGFzaCkgJiZcbiAgICAgICAgY2xhc3NOYW1lc0luY2x1ZGluZ0Zyb21TZWxlY3RvcnMuYWRkKGhhc2gpXG4gICAgKVxuXG4gIGhhc2hlcy5mb3JFYWNoKGFkZEhhc2hGcm9tU2VsZWN0b3JMaXN0VG9DbGFzc05hbWVzKVxuXG4gIHJldHVybiBbLi4uY2xhc3NOYW1lc0luY2x1ZGluZ0Zyb21TZWxlY3RvcnNdXG59XG5cbmNvbnN0IHJlcGxhY2VDbGFzc05hbWVzID0gKHJlc3VsdCwgY2xhc3NOYW1lcywgc3R5bGUpID0+XG4gIGNsYXNzTmFtZXNcbiAgICAuZmlsdGVyKGNsYXNzTmFtZSA9PiBzdHlsZS5pbmNsdWRlcyhjbGFzc05hbWUpKVxuICAgIC5yZWR1Y2UoXG4gICAgICAoYWNjLCBjbGFzc05hbWUsIGluZGV4KSA9PlxuICAgICAgICBhY2MucmVwbGFjZShuZXcgUmVnRXhwKGNsYXNzTmFtZSwgJ2cnKSwgYGMke2luZGV4Kyt9YCksXG4gICAgICByZXN1bHRcbiAgICApXG5cbmNvbnN0IHJlcGxhY2VIYXNoZXMgPSAocmVzdWx0LCBoYXNoZXMpID0+XG4gIGhhc2hlcy5yZWR1Y2UoXG4gICAgKGFjYywgY2xhc3NOYW1lKSA9PlxuICAgICAgYWNjLnJlcGxhY2UoXG4gICAgICAgIG5ldyBSZWdFeHAoYCgoY2xhc3N8Y2xhc3NOYW1lKT1cIlteXCJdKj8pJHtjbGFzc05hbWV9XFxcXHM/KFteXCJdKlwiKWAsICdnJyksXG4gICAgICAgICckMSQzJ1xuICAgICAgKSxcbiAgICByZXN1bHRcbiAgKVxuXG5jb25zdCBzdHlsZVNoZWV0U2VyaWFsaXplciA9IHtcbiAgdGVzdCh2YWwpIHtcbiAgICByZXR1cm4gKFxuICAgICAgdmFsICYmXG4gICAgICAhdmFsW0tFWV0gJiZcbiAgICAgICh2YWwuJCR0eXBlb2YgPT09IFN5bWJvbC5mb3IoJ3JlYWN0LnRlc3QuanNvbicpIHx8XG4gICAgICAgIChnbG9iYWwuRWxlbWVudCAmJiB2YWwgaW5zdGFuY2VvZiBnbG9iYWwuRWxlbWVudCkpXG4gICAgKVxuICB9LFxuXG4gIHByaW50KHZhbCwgcHJpbnQpIHtcbiAgICBjb25zdCBub2RlcyA9IGdldE5vZGVzKHZhbClcbiAgICBtYXJrTm9kZXMobm9kZXMpXG5cbiAgICBjb25zdCBoYXNoZXMgPSBnZXRIYXNoZXMoKVxuICAgIGxldCBjbGFzc05hbWVzID0gWy4uLmdldENsYXNzTmFtZXMobm9kZXMpXVxuICAgIGNsYXNzTmFtZXMgPSBmaWx0ZXJDbGFzc05hbWVzKGNsYXNzTmFtZXMsIGhhc2hlcylcblxuICAgIGNvbnN0IHN0eWxlID0gZ2V0U3R5bGUoY2xhc3NOYW1lcylcbiAgICBjb25zdCBjbGFzc05hbWVzVG9SZXBsYWNlID0gZ2V0Q2xhc3NOYW1lc0Zyb21TZWxlY3RvcnNCeUhhc2hlcyhcbiAgICAgIGNsYXNzTmFtZXMsXG4gICAgICBoYXNoZXNcbiAgICApXG4gICAgY29uc3QgY29kZSA9IHByaW50KHZhbClcblxuICAgIGxldCByZXN1bHQgPSBgJHtzdHlsZX0ke3N0eWxlID8gJ1xcblxcbicgOiAnJ30ke2NvZGV9YFxuICAgIHJlc3VsdCA9IHJlcGxhY2VDbGFzc05hbWVzKHJlc3VsdCwgY2xhc3NOYW1lc1RvUmVwbGFjZSwgc3R5bGUpXG4gICAgcmVzdWx0ID0gcmVwbGFjZUhhc2hlcyhyZXN1bHQsIGhhc2hlcylcblxuICAgIHJldHVybiByZXN1bHRcbiAgfSxcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBzdHlsZVNoZWV0U2VyaWFsaXplclxuIl19